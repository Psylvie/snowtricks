{% extends 'base.html.twig' %}

{% block title %}Éditer le Trick{% endblock %}

{% block body %}
    <div class="container my-5 bg-light">
        <!-- Image principale -->
        <div class="position-relative overflow-hidden mb-5" style="height: 400px;">
{#            {% if mainPicture %}#}
{#                <img src="{{ asset('uploads/TrickPictures/' ~ mainPicture.filename) }}" alt="Image principale du trick" class="w-100 h-100 position-absolute top-0 start-0 object-fit-cover" style="object-position: center;">#}
{#            {% else %}#}
                <img src="{{ asset('images/SnowTrick_0.png') }}" alt="Image principale du trick" class="w-100 h-100 position-absolute top-0 start-0 object-fit-cover" style="object-position: center;">
{#            {% endif %}#}
            <div class="position-relative text-center text-light bg-dark bg-opacity-50 p-3 rounded z-index-2" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                <h1 class="display-4 fw-bolder">{{ trick.name }}</h1>
            </div>
            <div class="position-absolute top-0 end-0 p-3 z-index-2">
                <div class="d-flex flex-row gap-2">
                    <a href="#" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#editMainPictureModal"><i class="bi bi-pencil"></i></a>
{#                    <a href="#" class="btn btn-secondary delete-image-main" data-picture-id="{{ mainPicture.id }}">#}
                        <i class="bi bi-trash text-danger"></i>
{#                    </a>#}
                </div>
            </div>
        </div>

        <!--  Videos -->
        <div class="row mb-5">
            {% for video in trick.videos %}
                <div class="col-md-2 mb-4">
                    <div class="media-card bg-dark text-light">
                        <div class="media-card-body p-0">
                            {% if video.videolink %}
                                <div class="video-embed">
                                    <iframe src="{{ video.videolink }}" frameborder="0" allowfullscreen></iframe>
                                </div>
                            {% else %}
                                <p class="text-warning">Vidéo non disponible</p>
                            {% endif %}
                        </div>
                        <div class="media-card-footer">
                            <div class="media-actions">
                                <a href="#"
                                   class="btn btn-sm btn-secondary"
                                   data-bs-toggle="modal"
                                   data-bs-target="#editVideoModal"
                                   data-video-id="{{ video.id }}"
                                   data-video-link="{{ video.videolink }}">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="btn btn-secondary delete-video-link" data-video-id="{{ video.id }}">
                                    <i class="bi bi-trash text-danger"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            <!--  Pictures -->
            {% for picture in trick.pictures %}
                <div class="col-md-2 mb-4">
                    <div class="media-card bg-dark text-light">
                        <div class="picture-container">
                            <img src="{{ asset('uploads/TrickPictures/' ~ picture.filename) }}" class="img-fluid rounded-top" alt="Image supplémentaire du trick">
                        </div>
                        <div class="media-card-footer">
                            <div class="media-actions">
                                <a href="#"
                                   class="btn btn-sm btn-secondary"
                                   data-bs-toggle="modal"
                                   data-bs-target="#editImageModal"
                                   data-picture-id="{{ picture.id }}">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="btn btn-secondary delete-picture-link" data-picture-id="{{ picture.id }}">
                                    <i class="bi bi-trash text-danger"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {{ form_start(form) }}
        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <div class="mb-4">
                    <label class="form-label">Création le :</label>
                    <p class="form-control-plaintext">{{ trick.createdAt|date('d/m/Y') }}</p>
                </div>

                {% if trick.updatedAt is defined%}
                    <div class="mb-4">
                        <label class="form-label">Modification le :</label>
                        <p class="form-control-plaintext">{{ trick.updatedAt|date('d/m/Y') }}</p>
                    </div>
                {% endif %}

                <div class="mb-4">
                    {{ form_widget(form.description, {'attr': {'class': 'form-control'}}) }}
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-list"></i></span>
                            {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                        </div>
                    </div>

                    <div class="col-md-9 d-flex justify-content-end align-items-start">
                        <button type="submit" class="btn btn-success">Sauvegarder</button>
                    </div>
                </div>

                <div class="mb-4">
                    {{ form_label(form.pictures, null, {'attr': {'class': 'form-label'}}) }}
                    {{ form_widget(form.pictures, {'attr': {'multiple': 'multiple'}}) }}
                    {{ form_errors(form.pictures) }}
                </div>

                <h3>Vidéos</h3>
                <div id="videos-list" data-prototype="{{ form_widget(form.videos.vars.prototype)|e('html_attr') }}">
                    {{ form_row(form.videos) }}
                </div>
                <button type="button" id="add-video" class="btn btn-add">Ajouter une vidéo</button>

                <p>{{ form_errors(form) }}</p>
            </div>
        </div>
        {{ form_end(form) }}
        <a href="{{ path('app_trick_delete', {'id': trick.id}) }}" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce trick ?');" >
            <button type="submit" class="btn btn-danger">Supprimer</button>
        </a>
        <a href="{{ path('app_trick_list') }}" class="btn btn-secondary mt-3">Annuler</a>
    </div>

    <!-- Modal picture -->
    <div class="modal fade" id="editImageModal" tabindex="-1" aria-labelledby="editImageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editImageModalLabel">Modifier l'image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editImageForm" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="newImage" class="form-label">Télécharger une nouvelle image</label>
                            <input type="file" class="form-control" id="newImage" name="newImage">
                        </div>
                        <input type="hidden" id="pictureId" name="pictureId">
                        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal vidéo -->
    <div class="modal fade" id="editVideoModal" tabindex="-1" aria-labelledby="editVideoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editVideoModalLabel">Modifier la Vidéo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editVideoForm" method="post">
                        <input type="hidden" id="videoId" name="videoId">
                        <div class="mb-3">
                            <label for="newVideoLink" class="form-label">Nouveau lien vidéo</label>
                            <input type="url" class="form-control" id="newVideoLink" name="newVideoLink" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        const editImageModal = document.getElementById('editImageModal');
        editImageModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const pictureId = button.getAttribute('data-picture-id');
            const pictureIdInput = document.getElementById('pictureId');
            pictureIdInput.value = pictureId;
        });
        document.addEventListener('DOMContentLoaded', function () {
            const videoModal = document.getElementById('editVideoModal');
            if (videoModal) {
                videoModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget; // Button that triggered the modal
                    const videoId = button.getAttribute('data-video-id');
                    const videoLink = button.getAttribute('data-video-link');

                    const modalVideoId = videoModal.querySelector('#videoId');
                    const modalVideoLink = videoModal.querySelector('#newVideoLink');

                    modalVideoId.value = videoId;
                    modalVideoLink.value = videoLink;
                });
            }
        });


            // suppression  images
            document.querySelectorAll('.delete-picture-link').forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const pictureId = this.getAttribute('data-picture-id');
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette image ?')) {
                        fetch('{{ path('app_trick_edit', {id: trick.id}) }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({ delete_picture_id: pictureId })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    location.reload();
                                } else {
                                    alert('Erreur lors de la suppression de l\'image.');
                                }
                            });
                    }
                });
            });

            // suppression vidéos
            document.querySelectorAll('.delete-video-link').forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const videoId = this.getAttribute('data-video-id');
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette vidéo ?')) {
                        fetch('{{ path('app_trick_edit', {id: trick.id}) }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({ delete_video_id: videoId })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    location.reload();
                                } else {
                                    alert('Erreur lors de la suppression de la vidéo.');
                                }
                            });
                    }
                });
            });

    </script>
{% endblock %}
